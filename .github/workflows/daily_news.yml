name: Daily LLM News Collection

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤© UTC 01:00 (åŒ—äº¬æ—¶é—´ 09:00)
  schedule:
    - cron: '0 1 * * *'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sources:
        description: 'æ•°æ®æº (é€—å·åˆ†éš”)'
        required: false
        default: 'hackernews,reddit,twitter,weibo_zhihu,tech_news'
        type: string
      days:
        description: 'å›žæº¯å¤©æ•°'
        required: false
        default: '1'
        type: string
      dry_run:
        description: 'è·³è¿‡LLMæ‘˜è¦ (true/false)'
        required: false
        default: 'false'
        type: string

permissions:
  contents: write

jobs:
  collect-news:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸŽ­ Install Playwright browsers (if needed)
        run: |
          playwright install chromium
        if: contains(github.event.inputs.sources || 'weibo_zhihu', 'weibo_zhihu')

      - name: ðŸš€ Run news collector
        env:
          # Twitter/X
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
          # Reddit
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: 'Get-LLM-News/1.0 (GitHub Actions)'
          # LLM
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'claude' }}
          # å¾®åš/çŸ¥ä¹Ž
          WEIBO_COOKIE: ${{ secrets.WEIBO_COOKIE }}
          ZHIHU_COOKIE: ${{ secrets.ZHIHU_COOKIE }}
        run: |
          SOURCES="${{ github.event.inputs.sources || 'hackernews,reddit,tech_news' }}"
          DAYS="${{ github.event.inputs.days || '1' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          CMD="python main.py --sources $SOURCES --days $DAYS"
          if [ "$DRY_RUN" = "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "ðŸ”§ Running: $CMD"
          $CMD

      - name: ðŸ“ Commit and push report
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶
          if [ -n "$(ls -A reports/*.md 2>/dev/null)" ]; then
            git add reports/
            DATE=$(date +%Y-%m-%d)
            git commit -m "ðŸ“° Daily AI Coding Tools Report - $DATE" || echo "No changes"
            git push
          else
            echo "No reports generated, skipping commit."
          fi

      - name: ðŸ“Š Upload report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-report-${{ github.run_number }}
          path: reports/
          retention-days: 30
